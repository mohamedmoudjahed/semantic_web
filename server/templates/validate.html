{% extends "base.html" %}
{% block title %}SHACL Validation - Tolkien KG{% endblock %}

{% block content %}
<h2>SHACL Validation</h2>

<div class="section">
    <p>
        This page validates the Knowledge Graph against SHACL shapes derived from 
        <a href="https://tolkiengateway.net/wiki/Category:Infobox_templates" target="_blank">Tolkien Gateway infobox templates</a>.
    </p>
    
    {% if fuseki_mode %}
    <div class="message success">
        <strong>✓ Fuseki Mode</strong> - Validation will query the triplestore.
    </div>
    {% endif %}
    
    <form method="get">
        <input type="hidden" name="run" value="true">
        <button type="submit">Run Validation</button>
    </form>
</div>

{% if report %}
<div class="section">
    <h3>Validation Results</h3>
    
    <div class="message {% if report.conforms %}success{% else %}error{% endif %}">
        <strong>Conforms: {{ report.conforms }}</strong>
    </div>
    
    <div class="stats">
        <div class="stat-item">
            <div class="stat-number">{{ report.statistics.total_triples }}</div>
            <div class="stat-label">Total Triples</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ report.statistics.characters }}</div>
            <div class="stat-label">Characters</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ report.statistics.locations }}</div>
            <div class="stat-label">Locations</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ report.statistics.artifacts }}</div>
            <div class="stat-label">Artifacts</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ report.statistics.events }}</div>
            <div class="stat-label">Events</div>
        </div>
    </div>
    
    {% if report.violations %}
    <h4>Violations ({{ report.violations|length }})</h4>
    <table class="properties-table">
        <thead>
            <tr>
                <th>Entity</th>
                <th>Type</th>
                <th>Violation</th>
            </tr>
        </thead>
        <tbody>
            {% for v in report.violations[:20] %}
            <tr>
                <td><a href="/resource/{{ v.entity.split('/')[-1] }}">{{ v.entity.split('/')[-1] }}</a></td>
                <td>{{ v.type }}</td>
                <td style="color: #dc3545;">{{ v.violation }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if report.violations|length > 20 %}
    <p><em>... and {{ report.violations|length - 20 }} more violations</em></p>
    {% endif %}
    {% endif %}
    
    {% if report.warnings %}
    <h4>Warnings ({{ report.warnings|length }})</h4>
    <table class="properties-table">
        <thead>
            <tr>
                <th>Entity</th>
                <th>Type</th>
                <th>Warning</th>
            </tr>
        </thead>
        <tbody>
            {% for w in report.warnings[:10] %}
            <tr>
                <td><a href="/resource/{{ w.entity.split('/')[-1] }}">{{ w.entity.split('/')[-1] }}</a></td>
                <td>{{ w.type }}</td>
                <td style="color: #856404;">{{ w.violation }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if report.warnings|length > 10 %}
    <p><em>... and {{ report.warnings|length - 10 }} more warnings</em></p>
    {% endif %}
    {% endif %}
    
    {% if not report.violations and not report.warnings %}
    <p style="color: #155724;"><strong>✓ No violations or warnings found!</strong></p>
    {% endif %}
</div>
{% endif %}

<div class="section">
    <h3>SHACL Shapes (derived from Infobox templates)</h3>
    <p>
        Each shape validates entities of a specific type against constraints derived from 
        the corresponding Tolkien Gateway infobox template.
    </p>
    
    <h4>Shapes defined:</h4>
    <ul>
        <li><code>tont:CharacterShape</code> - Based on <a href="https://tolkiengateway.net/wiki/Template:Infobox_character" target="_blank">Infobox character</a></li>
        <li><code>tont:LocationShape</code> - Based on <a href="https://tolkiengateway.net/wiki/Template:Infobox_location" target="_blank">Infobox location</a></li>
        <li><code>tont:ArtifactShape</code> - Based on <a href="https://tolkiengateway.net/wiki/Template:Infobox_object" target="_blank">Infobox object</a></li>
        <li><code>tont:EventShape</code> - Based on <a href="https://tolkiengateway.net/wiki/Template:Infobox_battle" target="_blank">Infobox battle</a></li>
        <li><code>tont:METWCardShape</code> - For METW card data</li>
    </ul>
    
    <h4>SHACL Shapes (Turtle format)</h4>
    <pre style="max-height: 400px; overflow: auto;">{{ shapes_turtle }}</pre>
</div>
{% endblock %}
